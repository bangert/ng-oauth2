"use strict";angular.module("ng-oauth2",["ng-oauth2.token","ng-oauth2.profile","ng-oauth2.endpoint"]).provider("Oauth",function(){var e={oauthServerAddress:"",clientId:"",profileUrl:"",unauthorizedUrl:"",logoutUrl:"",responseType:"token",scope:"",state:"",headerTokenName:"Authorization",randomizeState:!0,redirectOnUnauthorized:!0,sendTokenOnEveryRequest:!0,redirectOnLogout:!0};return{setOauthServerAddress:function(t){e.oauthServerAddress=t},setClientId:function(t){e.clientId=t},setProfileUrl:function(t){e.profileUrl=t},setUnauthorizedUrl:function(t){e.unauthorizedUrl=t},setResponseType:function(t){e.responseType=t},setLogoutUrl:function(t){e.logoutUrl=t},setScope:function(t){e.scope=t},setState:function(t){e.state=t},setHeaderTokenName:function(t){e.headerTokenName=t},setRandomizeState:function(t){e.randomizeState=t},setRedirectOnUnauthorized:function(t){e.redirectOnUnauthorized=t},setSendTokenOnEveryRequest:function(t){e.sendTokenOnEveryRequest=t},setRedirectOnLogout:function(t){e.redirectOnLogout=t},$get:function(){return e}}}),angular.module("ng-oauth2").config(["$httpProvider",function(e){e.interceptors.push("OauthHttpInterceptor"),e.interceptors.push("OauthUnauthorizedHttpInterceptor")}]),angular.module("ng-oauth2.endpoint",[]).factory("OauthEndpoint",["$window","$location","Oauth",function(e,t,o){return{getOauthUrl:function(){return o.oauthServerAddress+"?response_type="+o.responseType+"&client_id="+encodeURIComponent(o.clientId)+"&redirect_uri="+encodeURIComponent(t.absUrl())+"&scope="+o.scope+"&state="+o.state},redirectToOauthPage:function(){this.redirectToUrl(this.getOauthUrl())},redirectToUnauthorizedPage:function(){this.redirectToUrl(o.unauthorizedUrl)},redirectToLogoutPage:function(){this.redirectToUrl(o.logoutUrl)},redirectToUrl:function(t){e.location.assign(t)}}}]),angular.module("ng-oauth2").factory("OauthHttpInterceptor",["Oauth","OauthToken",function(e,t){return{request:function(o){return e.sendTokenOnEveryRequest&&t.getToken()&&(o.headers[e.headerTokenName]="authorization"==e.headerTokenName.toLowerCase?"Bearer "+t.getToken().access_token:t.getToken().access_token),o}}}]),angular.module("ng-oauth2.profile",[]).factory("OauthProfile",["$rootScope","$q","$http","Oauth",function(e,t,o,n){return e.oauthProfile=null,e.getOauthProfile=function(){return e.oauthProfile},e.hasOauthProfile=function(){return!!e.oauthProfile},{makeProfileRequest:function(){var r=t.defer();return o.get(n.profileUrl).success(function(t){e.oauthProfile=t,r.resolve(t)}).error(function(){r.reject("error")}),r.promise}}}]),angular.module("ng-oauth2").run(["$rootScope","OauthToken","OauthProfile","OauthEndpoint",function(e,t,o,n){var r=t.getTokenFromString();t.removeFragment(),r&&t.setToken(r),t.isTokenSet()&&!t.isExpired()&&o.makeProfileRequest(),t.isTokenSet()&&t.isExpired()&&n.redirectToOauthPage(),t.isTokenSet()||n.redirectToOauthPage(),e.$on("oauth2:logout",function(){e.oauthLogout()})}]),angular.module("ng-oauth2.token",["ngStorage"]).factory("OauthToken",["$rootScope","$location","$sessionStorage","$timeout","Oauth","OauthEndpoint",function(e,t,o,n,r,u){var i=["access_token","token_type","expires_in","scope","state","error","error_description"];return e.oauthLogout=function(){delete o.oauthToken,r.redirectOnLogout&&n(function(){u.redirectToLogoutPage()},110)},{setToken:function(e){e.expires_at=this.getExpiresAt(e.expires_in),o.oauthToken=e},getExpiresAt:function(e){var t=new Date;return t.setSeconds(t.getSeconds()+parseInt(e)),t.getTime()},getToken:function(){return o.oauthToken},isTokenSet:function(){return this.getToken()?!0:!1},getTokenFromString:function(){for(var e,o={},n=/([^&=]+)=([^&]*)/g;e=n.exec(t.hash());)o[decodeURIComponent(e[1])]=decodeURIComponent(e[2]);return o.access_token||o.error?o:void 0},removeFragment:function(){var e=t.hash();angular.forEach(i,function(t){var o=new RegExp("&"+t+"(=[^&]*)?|^"+t+"(=[^&]*)?&?");e=e.replace(o,"")}),t.hash(e)},isExpired:function(){return this.getToken().expires_at?(new Date).getTime()>=this.getToken().expires_at:!0}}}]),angular.module("ng-oauth2").factory("OauthUnauthorizedHttpInterceptor",["$rootScope","$q","Oauth","OauthEndpoint",function(e,t,o,n){return{responseError:function(e){return o.redirectOnUnauthorized&&401===e.status&&n.redirectToUnauthorizedPage(),t.reject(e)}}}]);